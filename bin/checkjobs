#!/usr/bin/perl

my $dir = '.';
if ($#ARGV >= 0) {$dir = $ARGV[0];}

my @jobs = &get_jobs($dir);

for my $job (@jobs) {
    my $status = status($job->{'job id'});
    my $name = $job->{'command'};
    $name =~ s| .*||g;
    $name =~ s|.*/||g;
    print "$job->{'directory'}     $job->{'job id'}     $name     $status";
    print "     ",$job->{'hostname'} if ($status eq "running");
    print "\n";
}

sub get_job {
    my $job = {};
    my $filename = shift;
    open(FILE,$filename);
    while(my $line=<FILE>) {
	if ($line =~ /(.*): (.*)/) {
	    $job->{$1}=$2;
	}
    }

    my $dir = $filename;
    $dir =~ s|/job_info.*||;
    $job->{'directory'} = $dir;

    close(FILE);
    return $job;
}

sub get_jobs {
    my $dir = shift;
    my @files = split(/\s+/,`find $dir -name job_info.?`);
    my @jobs=();
    foreach my $file (@files) {
	my $job = get_job($file);
	push @jobs,$job;
    }
    return @jobs;
}

sub status {
    my $job = shift;
    my $status = `qstat | grep $job`;
    chomp $status;
#    print $status;
    if ("$status") {return "running";}
    else {return "already done";}
}


