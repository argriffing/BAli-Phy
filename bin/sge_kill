#!/usr/bin/perl

use strict;

my $dir;

while(1) {
    $dir = shift;
    last if (!defined($dir));
    my @jobs = get_jobs($dir);
    kill_jobs(@jobs);
}

sub get_job {
    my $job = {};
    my $filename = shift;
    open(FILE,$filename);
    while(my $line=<FILE>) {
	if ($line =~ /(.*): (.*)/) {
	    $job->{$1}=$2;
	}
    }

    my $dir = $filename;
    $dir =~ s|/job_info.*||;
    $job->{'directory'} = $dir;

    close(FILE);
    return $job;
}

sub get_jobs {
    my $dir = shift;
    my @files = split(/\s+/,`find $dir -name job_info.?`);
    my @jobs=();
    foreach my $file (@files) {
	my $job = get_job($file);
	push @jobs,$job;
    }
    return @jobs;
}

sub status {
    my $job = shift;
    my $status = `qstat | grep $job`;
    chomp $status;
#    print $status;
    if ("$status") {return "running";}
    else {return "already done";}
}


sub kill_jobs {
    my @jobs = @_;

    for my $job (@jobs) {
	my $id = $job->{'job id'};
	print "killing $job->{'directory'}/$id     (",status($id),")\n";
	`qdel $id`;
    }
}

